name: Auto Elo Test
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make wget
        
        # Download fastchess v1.7.0-alpha
        wget https://github.com/Disservin/fastchess/releases/download/v1.7.0-alpha/fastchess-linux-x86-64.tar
        tar -xvf fastchess-linux-x86-64.tar
        if [ -f fastchess-linux-x86-64/fastchess ]; then mv fastchess-linux-x86-64/fastchess .; fi
        chmod +x fastchess

    - name: Build Nextfish (Challenger)
      run: |
        cd src
        make -j2 build ARCH=x86-64-modern COMP=gcc werror=no
        make net
        cp *.nnue ../
        mv stockfish ../nextfish

    - name: Download Stockfish 17.1 (Baseline)
      run: |
        # Download official Stockfish 17.1 binary
        wget https://github.com/official-stockfish/Stockfish/releases/download/sf_17.1/stockfish-ubuntu-x86-64-avx2.tar
        tar -xvf stockfish-ubuntu-x86-64-avx2.tar
        # The extraction folder name matches the tarball name usually
        mv stockfish/stockfish-ubuntu-x86-64-avx2 ./stockfish_17_1
        chmod +x stockfish_17_1

    - name: Run Elo Match (100 Games)
      run: |
        # Chạy v1.7.0-alpha với đối thủ là SF 17.1
        ./fastchess -engine name=Nextfish cmd=./nextfish \
                    -engine name=Stockfish_17.1 cmd=./stockfish_17_1 \
                    -each proto=uci tc=10+0.2 option.Hash=16 option.Threads=1 \
                    -rounds 50 -games 2 \
                    -repeat -concurrency 2 \
                    -recover \
                    -pgnout file=test_match.pgn
      
    - name: Upload PGN
      uses: actions/upload-artifact@v4
      with:
        name: test-elo-pgn
        path: test_match.pgn
