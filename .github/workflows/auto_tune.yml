name: Auto SPSA Tuning Loop
on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  auto-tune:
    if: contains(github.event.head_commit.message, '[tune]') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Sử dụng Token cá nhân để vượt qua rào cản bảo mật của GitHub
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make wget python3
        wget https://github.com/Disservin/fastchess/releases/download/v1.7.0-alpha/fastchess-linux-x86-64.tar
        tar -xvf fastchess-linux-x86-64.tar
        if [ -f fastchess-linux-x86-64/fastchess ]; then mv fastchess-linux-x86-64/fastchess .; fi
        chmod +x fastchess

    - name: Build Engine
      run: |
        cd src
        make -j2 build ARCH=x86-64-bmi2 COMP=gcc werror=no
        mv stockfish ../nextfish

    - name: Run SPSA Tuning (25 Iterations - PRODUCTION)
      run: |
        # Tăng lên 25 vòng (500 ván) để đảm bảo độ chính xác cao
        python3 spsa_runner.py 25

    - name: Apply New Parameters
      run: |
        python3 apply_tuning.py

    - name: Commit & Push (Evolution)
      id: push_step
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name 'Nextfish Auto-Tuner'
        git config --global user.email 'bot@nextfish.ai'
        
        # Ensure we are on the latest remote state
        git fetch origin ${{ github.ref_name }}
        git reset --soft origin/${{ github.ref_name }}
        
        # Thêm thay đổi nhỏ vào README để đảm bảo luôn có sự thay đổi file (vượt lỗi No changes)
        echo "Last evolution: $(date)" >> evolution_log.txt
        
        git add src/nextfish_strategy.cpp evolution_log.txt
        
        # Kiểm tra xem có gì để commit không
        if git diff --staged --quiet; then
          echo "No parameter changes, pushing log update only."
          git commit -m "Auto-Tune: Keepalive cycle [tune]"
        else
          git commit -m "Auto-Tune: Evolution cycle complete [tune]"
        fi
        
        # Push using the token explicitly. 
        # Note: If using GITHUB_TOKEN, this push will NOT trigger 'on: push' workflows.
        git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}

    - name: Trigger Next Iteration
      if: always() && steps.push_step.outcome == 'success'
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        echo "Waiting a bit before triggering next cycle..."
        sleep 10
        echo "Triggering next tuning cycle via workflow_dispatch..."
        # We use workflow_dispatch to bypass the 'push trigger' restriction of GITHUB_TOKEN
        gh workflow run auto_tune.yml --ref ${{ github.ref_name }} || echo "Failed to trigger next run, but push was successful."
