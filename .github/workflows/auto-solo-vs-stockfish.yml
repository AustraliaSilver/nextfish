name: Auto Elo Nextfish vs Stockfish

on:
  push:
    branches: [main, master]
    paths:
      - "nextfish-dev/Stockfish-master/src/**"
      - "Stockfish-master/Stockfish-master/src/**"
      - ".github/workflows/auto-solo-vs-stockfish.yml"
  workflow_dispatch:
    inputs:
      games:
        description: "Number of games"
        required: false
        default: "500"
      tc:
        description: "Time control"
        required: false
        default: "10+0.1"
      concurrency:
        description: "Cutechess concurrency"
        required: false
        default: "4"
      threads:
        description: "Threads per engine"
        required: false
        default: "1"
      hash:
        description: "Hash MB per engine"
        required: false
        default: "128"

permissions:
  contents: read

concurrency:
  group: elo-solo-${{ github.ref }}
  cancel-in-progress: true

jobs:
  elo:
    runs-on: [self-hosted, windows]
    timeout-minutes: 360
    env:
      GAMES: ${{ github.event_name == 'push' && '500' || (github.event.inputs.games || '500') }}
      TC: ${{ github.event.inputs.tc || '10+0.1' }}
      CONCURRENCY: ${{ github.event.inputs.concurrency || '4' }}
      THREADS: ${{ github.event.inputs.threads || '1' }}
      HASH: ${{ github.event.inputs.hash || '128' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force builds | Out-Null
          New-Item -ItemType Directory -Force matches | Out-Null

      - name: Verify toolchain
        shell: pwsh
        run: |
          if (-not (Test-Path ".\cutechess-cli.exe") -and -not (Test-Path ".\cutechess-cli")) {
            throw "cutechess-cli not found in repo root"
          }
          if (-not (Test-Path "C:\msys64\usr\bin\bash.exe")) {
            throw "MSYS2 bash not found at C:\msys64\usr\bin\bash.exe"
          }

      - name: Build Nextfish (PGO + O3 + LTO)
        shell: pwsh
        run: |
          $ws = $env:GITHUB_WORKSPACE -replace '\\','/'
          $ws = $ws -replace '^([A-Za-z]):','/$1'
          C:\msys64\usr\bin\bash -lc "export PATH=/mingw64/bin:/usr/bin:/bin:\$PATH; cd $ws/nextfish-dev/Stockfish-master/src && make -j4 profile-build ARCH=native COMP=gcc && make strip ARCH=native COMP=gcc"

      - name: Build Stockfish (PGO + O3 + LTO)
        shell: pwsh
        run: |
          $ws = $env:GITHUB_WORKSPACE -replace '\\','/'
          $ws = $ws -replace '^([A-Za-z]):','/$1'
          C:\msys64\usr\bin\bash -lc "export PATH=/mingw64/bin:/usr/bin:/bin:\$PATH; cd $ws/Stockfish-master/Stockfish-master/src && make -j4 profile-build ARCH=native COMP=gcc && make strip ARCH=native COMP=gcc"

      - name: Normalize shared NNUE nets
        shell: pwsh
        run: |
          $nextSrc = "nextfish-dev/Stockfish-master/src"
          $stockSrc = "Stockfish-master/Stockfish-master/src"
          $netFiles = Get-ChildItem "$nextSrc/nn-*.nnue" -File -ErrorAction SilentlyContinue
          if (-not $netFiles) {
            throw "No nn-*.nnue found in $nextSrc"
          }
          foreach ($f in $netFiles) {
            Copy-Item $f.FullName (Join-Path $stockSrc $f.Name) -Force
          }
          Write-Host "Shared nets:" ($netFiles.Name -join ', ')

      - name: Save built binaries
        id: save_bin
        shell: pwsh
        run: |
          $stamp = Get-Date -Format 'yyyyMMdd_HHmmss'
          $next = "builds/nextfish_pgo_native_$stamp.exe"
          $stock = "builds/stockfish_orig_pgo_native_$stamp.exe"

          Copy-Item "nextfish-dev/Stockfish-master/src/stockfish.exe" $next -Force
          Copy-Item "Stockfish-master/Stockfish-master/src/stockfish.exe" $stock -Force

          "NEXTFISH_EXE=$next" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "STOCKFISH_EXE=$stock" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run Elo match (500 games on push)
        id: match
        shell: pwsh
        run: |
          $stamp = Get-Date -Format 'yyyyMMdd_HHmmss'
          $pgn = "matches/nextfish_vs_stockfish_${stamp}.pgn"
          $log = "matches/nextfish_vs_stockfish_${stamp}.log"
          $summary = "matches/nextfish_vs_stockfish_${stamp}.summary.txt"

          $args = @(
            '-engine', "cmd=$env:NEXTFISH_EXE", 'name=Nextfish', 'proto=uci',
            'option."MCTS Enabled"=true',
            'option."MCTS Iterations"=300',
            'option."MCTS Root Node Percent"=9',
            'option."MCTS Deep Enabled"=false',
            'option."AAW Enabled"=true',
            'option."AAW Base Delta"=8',
            'option."AAW Volatility Weight"=8',
            'option."AAW Trend Asymmetry"=8',
            'option."AAW Recenter Weight"=10',
            'option."AAW Directional Clamp"=false',
            "option.Threads=$env:THREADS",
            "option.Hash=$env:HASH",

            '-engine', "cmd=$env:STOCKFISH_EXE", 'name=Stockfish', 'proto=uci',
            "option.Threads=$env:THREADS",
            "option.Hash=$env:HASH",

            '-each', "tc=$env:TC",
            '-games', "$env:GAMES",
            '-pgnout', $pgn,
            '-concurrency', "$env:CONCURRENCY",
            '-repeat',
            '-draw', 'movenumber=40', 'movecount=8', 'score=10',
            '-resign', 'movecount=3', 'score=500'
          )

          if (Test-Path ".\UHO_2022_8mvs_+110_+119.pgn") {
            $args += @('-openings', 'file=UHO_2022_8mvs_+110_+119.pgn', 'format=pgn', 'order=random')
          }

          $cutechess = if (Test-Path ".\cutechess-cli.exe") { ".\cutechess-cli.exe" } else { ".\cutechess-cli" }

          & $cutechess @args 2>&1 | Tee-Object -FilePath $log
          if ($LASTEXITCODE -ne 0) { throw "cutechess-cli exited with code $LASTEXITCODE" }

          $scoreLine = Select-String -Path $log -Pattern '^Score of ' | Select-Object -Last 1
          $eloLine = Select-String -Path $log -Pattern '^Elo difference:' | Select-Object -Last 1
          $whiteLine = Select-String -Path $log -Pattern 'playing White:' | Select-Object -Last 1
          $blackLine = Select-String -Path $log -Pattern 'playing Black:' | Select-Object -Last 1
          $sprtLine = Select-String -Path $log -Pattern '^SPRT:' | Select-Object -Last 1

          @(
            "Nextfish exe: $env:NEXTFISH_EXE"
            "Stockfish exe: $env:STOCKFISH_EXE"
            "Games: $env:GAMES  TC: $env:TC  Concurrency: $env:CONCURRENCY"
            ($scoreLine.Line)
            ($eloLine.Line)
            ($whiteLine.Line)
            ($blackLine.Line)
            ($sprtLine.Line)
          ) | Where-Object { $_ } | Set-Content $summary

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Nextfish vs Stockfish (PGO, same NNUE files)"
          Get-Content $summary | ForEach-Object { Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- " + $_) }

          "pgn_path=$pgn" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "log_path=$log" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "summary_path=$summary" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: elo-nextfish-vs-stockfish-${{ github.run_id }}
          path: |
            ${{ steps.match.outputs.pgn_path }}
            ${{ steps.match.outputs.log_path }}
            ${{ steps.match.outputs.summary_path }}
          if-no-files-found: warn
