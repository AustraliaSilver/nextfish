name: Nextfish SPSA Optimizer
on:
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Total SPSA Iterations'
        required: true
        default: '1000'

jobs:
  spsa:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make
        wget https://github.com/Disservin/fastchess/releases/download/v1.7.0-alpha/fastchess-linux-x86-64.tar
        tar -xvf fastchess-linux-x86-64.tar
        mv fastchess-linux-x86-64/fastchess .
        chmod +x fastchess

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Tuning Tools
      run: |
        pip install requests
        # Download fastchess v0.12.0 (The last version with built-in SPSA)
        wget https://github.com/Disservin/fastchess/releases/download/v0.12.0/fastchess-v0.12.0-linux-x86-64.tar.gz
        tar -zxvf fastchess-v0.12.0-linux-x86-64.tar.gz
        chmod +x fastchess

    - name: Build Nextfish
      run: |
        cd src
        make -j2 build ARCH=x86-64-modern COMP=gcc werror=no
        make net
        cp *.nnue ../
        mv stockfish ../nextfish

    - name: Run SPSA Tuning
      run: |
        # Chạy SPSA bằng lệnh chuẩn của phiên bản Stable
        ./fastchess -engine name=Tuned cmd=./nextfish \
                    -engine name=Base cmd=./nextfish \
                    -each proto=uci tc=2+0.05 option.Hash=16 option.Threads=1 \
                    -rounds ${{ github.event.inputs.iterations }} \
                    -concurrency 2 \
                    -recover \
                    -spsa \
                      param=WhiteOptimism,value=20,min=0,max=40,step=2.0,alpha=0.602,gamma=0.101 \
                      param=BlackLossPessimism,value=-15,min=-40,max=0,step=2.0,alpha=0.602,gamma=0.101 \
                      param=VolatilityThreshold,value=14,min=5,max=30,step=1.0,alpha=0.602,gamma=0.101 \
                      param=CodeRedLMR,value=65,min=40,max=95,step=2.0,alpha=0.602,gamma=0.101 \
                      param=BlackLMR,value=88,min=70,max=100,step=2.0,alpha=0.602,gamma=0.101 \
                    -pgnout file=spsa_games.pgn
      
    - name: Upload SPSA Results
      uses: actions/upload-artifact@v4
      with:
        name: spsa-final-state
        path: |
          spsa_games.pgn
          fastchess.log
